# Исследование проекта WPS Apex

## Контекст
- Проект строится вокруг веб-системы Oracle APEX, в которой уже есть схема fullbox, и интеграция на FastAPI (см. nb/FApiT.py).
- Цель — создать комплект складских, клиентских и финансовых функций, описанных в техзадании по WMS/фулфилменту.
- Сейчас рабочая область APEX находится по адресу https://lk.ffullbox.ru/... и доступна через логин USER1 / FB_USER1!.

## Что уже есть в кодовой базе
- `nb/FApiT.py` — FastAPI с простыми маршрутизаторами: отдача PDF-файла (`/get-pdf`), запуск синхронизации Wildberries (`/sync-wb/{value}`) и вызов старой генерации КП (`/run-script/{value}`). API не защищен, логика синхронная, конфиг пустой.
- `nb/final_pdf.py` и `nb/old/new_scr.py` — два варианта генераторов коммерческих предложений по данным из Oracle (текущему калькулятору, раздел 4). Берут данные из схемы fullbox, считают суммы, строят PDF через ReportLab и сохраняют в таблицу fullbox.FB_FILE. Один из них уже вызывается в `FApiT`.
- `nb/sync_wb.py` и `nb/sync_ozon.py` — фоновые импортные скрипты, которые тянут карточки с маркетплейсов, получают ключи из таблиц `FB_AGNS_MARKET_ARTIKU` (MARKET_ID 2/3) и пишут недостающие записи в `FB_TOVAR_LIST` + `FB_TOVAR_LIST_SCHK`. Используют `oracledb` и JSON API.
- `nb/CR_AGN_SHED.py` — читает ИНН из `FB_AGNS`, обогащает через DaData (`BASE_URL` в paramet.py) и обновляет записи (название, адрес, ФИО). Параметры подключения в `nb/paramet.py` пока пустые.
- `nb/SCH.py` — демон, который раз в 5 минут запускает `CR_AGN_SHED.py` (путь зашит на E:\WEB_FB\BACK\nb). Комментарии могут отключать вызов `final_pdf`.
- В каталоге `nb/old` хранятся прежние версии генерации PDF и скриптов, которые можно использовать для рефакторинга.
- Есть изображения `photo.jpg` и `new_photo.jpg` для логотипов в PDF.

## Основные требования из техзадания
### Общая идея
- WMS фулфилмента + Личный кабинет клиента + модуль биллинга + работа с маркировкой «Честный знак». Система покрывает складские операции, ЛК, биллинг и интеграции, но не ведет полную бухгалтерию, не делает транспортную оптимизацию и не работает с кассами.

### Роли и безопасность
- Ролевая модель: администратор, складской оператор, логист/диспетчер, менеджер клиентского сервиса (МКС), клиент ЛК, финансовый администратор.
- Права привязаны в первую очередь к клиентам и складам, и пользователю показываются только данные по своим клиентам/складам.
- Важные действия логируются, возможна двухфакторная авторизация.

### Личный кабинет клиента (§3)
- Профиль клиента с реквизитами, контактами и складами, управление уведомлениями.
- Справочник SKU: артикул, наименования, штрихкоды, размеры и вес, единицы измерения, признаки маркировки, архивация, импорт/экспорт.
- Заявки на поставку: статусы от черновика до завершения приемки, история, комментарии МКС, фактические количества, партия/срок.
- Заказы на отгрузку: типы (B2B/B2C/маркетплейс), адрес доставки, параметры ТК, статусы (черновик → отгрузка → доставка), валидация остатков и частичная отгрузка.
- Заявки на дополнительную обработку: услуги (замена упаковки, маркировка, наборы), статусы, прогресс и результаты по позициям.
- Остатки и движения: фильтры, отображение по SKU/складу/партии, история операций.
- Финансовая информация: баланс, счета/акты, оплаты, лимиты, экспорт в Excel/PDF, предупреждения по лимитам, блокировки.
- Уведомления по событиям (заявки, статусы, счета, лимиты) через ЛК и e-mail.

### Складские операции (§5-9)
- Приемка: заявки из ЛК → проверка МКС → размещение, учет фактов (сканирование, партии, КМ). Маркированный товар требует контроля КМ на приемке.
- Обработка: заявки на отбор/упаковку, доп. обработки, управление заданиями, отслеживание статусов, связь с документами.
- Хранение: учёт остатков по зонам/ячеекам/партиям, перемещения, инвентаризации, корректировки.
- Отгрузка и логистика: планирование волн отбора, зоны отгрузки, реестры/накладные, взаимодействие с ТК, сохранение треков, учет КМ при отгрузке.

### Маркировка «Честный знак» (§6.6)
- Учет КМ на складах: нанесение, перемаркировка, возвраты, проверка принадлежности КМ клиенту, отслеживание статусов КМ.
- Интеграция с возвратами: сканирование этикеток, связь с исходной отгрузкой, выгрузки по документам/периодам.

### Биллинг и финансовые расчеты (§15)
- Справочник услуг (приемка, хранение, обработка, логистика, маркировка), тарифов (по клиенту, складу, услуге, сроку) и единиц тарификации.
- Автоматические начисления при завершении операций, расчет хранения (палета-день, короб-день), корректировки, сохранение истории тарифов.
- Балансы и лимиты: доступные лимиты могут блокировать или предупреждать при превышении, правила поведения настраиваются.
- Счета/акты: статусы (черновик, выставлен, оплачен частично/полностью), после выставления состав фиксируется.
- Оплаты: реестр, распределение на счета/акты или авансы, импорт из внешних систем, обязательное логирование.
- Отображение в ЛК и для МКС: баланс, счета, оплаты, отчеты, экспорт.

### Интеграции и отчеты
- REST API для управления номенклатурой, заявками, заказами, статусы, остатки, финансы.
- Интеграции с ERP/учетными системами (справочники, документы, финансы), ТК (создание отправлений, получение треков), платежными сервисами (по необходимости).
- Отчетность: оборотно-сальдовая, по операциям, SLA, расхождениям, по биллингу, экспорт в Excel/CSV/PDF.

### Нефункциональные и архитектурные требования
- Oтклик 2-3 секунды на типовые запросы, поддержка заданного числа пользователей, резервные копии, логирование ошибок.
- Web-интерфейс + адаптация под ТСД, HTTPS, аудит изменений, клиент-серверная архитектура, реляционная БД, отдельный слой для интеграций/фоновых задач.
- Тестирование: модульное, интеграционное, нагрузочное, приемо-сдаточное по основным сценариям (поставка, отгрузка, доп. обработка, маркировка, возвраты, инвентаризация, ЛК, биллинг).

## Разрывы между кодом и ТЗ
- Нет управления пользователями/ролями, нет Личного кабинета, нет синхронизации статусов заявок/операций и уведомлений.
- Отсутствует модуль биллинга: нет справочника услуг, тарифов, автоматических начислений, счетов/оплат и лимитов.
- Нет складской части: приемка, размещение, отбор, обработка, логистика реализованы только в документах, фактически их нет в API.
- Нет поддержки Честного знака в интерфейсе или базе, документы и операции не учитывают КМ.
- База `paramet.py` пуста, логика API/скриптов не защищена и не разделена по клиентам.

## Первые шаги
1. Расписать целевую модель данных (клиенты, SKU, документы, тарифы, начисления, КМ, аккаунты пользователей) и согласовать с Oracle.
2. Реализовать базовую авторизацию и роли с ограничениями по клиентам/складам, подготовить таблицы клиентов и логов.
3. Сделать MVP ЛК: управление SKU, заявки на поставки/отгрузки/обработку, доступ к остаткам и финансам, уведомления.
4. Построить скелет модулей склада: приемка → размещение → отгрузка, отслеживание статусов и задания для операторов или ТСД.
5. Создать модуль биллинга с тарифами, начислениями, счетами, оплатами, балансом и отчетами.
6. Интеграции: REST API для клиентов и фоновые задания для обмена с ERP/ТК/ЧЗ и маркетплейсами.
7. Добавить фоновые задачи, логирование/аудит, отчеты и подготовить тесты по ключевым сценариям.

## Дополнительно
- В качестве быстрого результата можно сделать документ с таблицей требований (ID / описание / приоритет) и простой график потоков заявок.
- Для генерации КП можно перейти на асинхронную очередь (например, Celery) вместо запуска скриптов вручную.
- Административная панель и ЛК должны быть отдельными интерфейсами с разными правами.

