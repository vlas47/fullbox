# Project Context

## Quick Summary
- Project name: Fullbox (internal fulfillment/WMS portal).
- Goal: manage SKU, orders/receiving, tasks, audits, role-based cabinets, and label printing.
- Current status: Django 6.0 app in production; latest updates on 2026-01-04 (placement act UI changes, favicon, template tweaks).

## Current Focus
- Last recorded focus: placement act UI in склад (pallet contents in table, SKU column, box extraction rule).
- Why it matters: clarifies warehouse placement workflow for storekeepers.

## Recent Decisions
- Decision: Django 6.0 + Python 3.12; default SQLite with optional PostgreSQL via env.
- Reason: lightweight local setup with production-ready DB option.
- Date: see `journal.md`.
- Decision: always deploy changes to server after edits (and restart service when needed).
- Reason: keep production in sync with local fixes.
- Date: 2026-01-04.

## Open Questions
- Question: confirm scope/ownership of Oracle APEX + FastAPI integration (see `note.txt`).
- Owner: project lead.

## TODO (short list)
- [ ] Capture current sprint goals / next tasks.
- [ ] Verify pending deployments or migrations.
- [ ] After reboot: confirm if busy cursor persists on desktop; if yes, check Task Manager/Explorer; if no, check browser extensions.

## How to Run / Test
- Setup: `python -m venv .venv`, `.venv\\Scripts\\activate`, `pip install -r requirements.txt`.
- Run: `python fullbox/manage.py migrate`, `python fullbox/manage.py runserver`.
- Tests: not documented.

## Key Files / Folders
- `README.md` - overview, routes, env vars.
- `description.md` - stack, modules, local run details.
- `journal.md` - detailed change log.
- `fullbox/` - Django apps and project code.
- `DEPLOY.md` - deployment steps.
- `LABEL_PRINT.md` - label printing spec.
- `server_access.md` - server access details (sensitive).
- `.env.example` - env vars reference.
- `Начальные таблицы/` - source XLSX data for `load_initial_tables`.
- `fullbox/db.sqlite3` - local SQLite DB (default).

## Notes for AI Assistant
- Preferred language: Russian (based on chat).
- Style constraints: concise, CLI-friendly; ask only when needed.
- Anything to avoid: do not paste credentials; refer to `server_access.md` and `note.txt` for secrets.
- This file is my memory aid; I must log each of my actions here.
- Always deploy changes to the server after edits.

## Restart Notes
- After reboot: check if busy cursor appears on desktop (not just browser).
- If yes: open Task Manager → sort by CPU/Disk; restart `Windows Explorer`.
- If no: test in incognito or disable extensions; share pending requests if any.

## AI Action Log
- 2026-01-09 10:14: keep in-box inputs empty unless user types manually; scan only updates box counts.
- 2026-01-09 10:07: show active box qty in the in-box input when no manual value and clear only the scanned row's manual input.
- 2026-01-09 10:01: focus scanned row using pending element after render to prevent cursor staying in the previous in-box input.
- 2026-01-09 09:54: move focus to scanned row input during table render to avoid losing focus on the first scan.
- 2026-01-09 09:48: defer focus transfer to scanned row with requestAnimationFrame so cursor reliably moves to the new in-box cell.
- 2026-01-09 09:44: move focus to scanned row input after scan while suppressing blur side effects.
- 2026-01-09 09:39: keep in-box inputs empty during scans and preserve manual entry values separately in receiving flow.
- 2026-01-09 09:27: relax scan detection when focus is in qty inputs so repeated scans increment counts reliably.
- 2026-01-09 09:13: keep last scanned row highlighted and avoid rerender timeout so focus stays in the in-box input.
- 2026-01-09 09:06: add idle-based scan detection to receiving flow so barcodes are captured even without Enter and restore focused input values.
- 2026-01-09 09:00: improved receiving flow scanner capture to work regardless of focus and add scanned SKU from client catalog when missing in the table, with clear status messages.
- 2026-01-09 08:47: remove client-confirmed response tasks after manager views the act print page and close manager receiving tasks so confirmed orders move to done.
- 2026-01-09 08:37: mark client-confirmed receiving act response tasks as done when manager opens the act print page so they move to the done column.
- 2026-01-04 09:40: prepared guidance on Windows Terminal settings locations (Russian UI).
- 2026-01-04 09:45: reviewed core Django config (`settings.py`, `urls.py`, `manage.py`).
- 2026-01-04 09:45: reviewed key models (`sku`, `todo`, `employees`, `audit`).
- 2026-01-04 09:45: reviewed key views (`orders`, `client_cabinet`, `sku`, `market_sync`).
- 2026-01-04 09:48: reviewed `sklad` app (views/urls/templates) and inventory journal templates.
- 2026-01-04 09:48: reviewed orders flow around storekeeper tasks and acts in `fullbox/orders/views.py`.
- 2026-01-04 09:48: reviewed task panel template tag used by storekeeper dashboard.
- 2026-01-04 09:52: inspected placement act template/JS to diagnose UI counts.
- 2026-01-04 10:01: updated placement act UI to show pallet contents and correct pallet item counts.
- 2026-01-04 10:04: user asked about deployment; changes are local only, not deployed.
- 2026-01-04 10:06: added reminder to always deploy; uploaded `fullbox/orders/templates/orders/placement_act.html` to server via scp.
- 2026-01-04 10:09: reviewed updated placement act UI screenshot feedback.
- 2026-01-04 10:15: moved pallet contents into pallets table (removed right sidebar active pallet panel) and redeployed template to server.
- 2026-01-04 10:19: verified server template has no "Активная палета" block; likely browser cache if still visible.
- 2026-01-04 10:21: searched server for placement_act template and "Активная палета" string; only one template exists and it lacks the block.
- 2026-01-04 10:26: restarted `fullbox` systemd service to refresh cached templates.
- 2026-01-04 10:35: changed pallet logic so boxes in pallet cannot be opened; updated UI to only extract, deployed template, restarted service.
- 2026-01-04 10:39: added SKU column to remaining items table in placement act; deployed template and restarted service.
- 2026-01-04 10:42: investigating report of busy cursor/spinner on placement page; suggested checking pending network requests.
- 2026-01-04 10:45: reviewed devtools screenshot; noted favicon 404 as likely cause of loading indicator.
- 2026-01-04 10:47: added `/favicon.ico` route (SVG) in `fullbox/fullbox/views.py` and `fullbox/fullbox/urls.py`, deployed and restarted service.
- 2026-01-04 10:50: advised checking pending network requests; suspect external fonts or extensions for spinner.
- 2026-01-04 10:58: removed external Google Fonts from placement act template to avoid hanging loads; deployed and restarted service.
- 2026-01-04 11:01: forced default cursor on placement act body to avoid busy cursor; deployed and restarted service.
- 2026-01-04 11:08: advised OS/browser-level troubleshooting for persistent busy cursor across all pages.
- 2026-01-04 11:26: listed project markdown files; reviewed README, description, DEPLOY, LABEL_PRINT, journal, and research notes to refresh project context.
- 2026-01-04 11:27: reviewed storekeeper cabinet (sklad) views/templates and orders (urls, journal/detail, receiving/placement act templates) to summarize workflows.
- 2026-01-04 11:35: reviewed placement act screenshot and checked UI logic in placement_act template to diagnose inconsistencies.
- 2026-01-04 11:45: updated receiving act status labels and placement act active-container logic to match storekeeper workflow.
- 2026-01-04 11:46: deployed updated placement act template and status logic to server; restarted fullbox service.
- 2026-01-04 11:50: removed placement act notice/banner and active container strip from template per screenshot feedback.
- 2026-01-04 11:51: deployed updated placement act template to server; restarted fullbox service.
- 2026-01-04 11:57: enforced placement-act close validation requiring all boxes assigned to pallets.
- 2026-01-04 11:57: deployed placement act validation update to server; restarted fullbox service.
- 2026-01-04 12:00: added placement act info summary (items/boxes/pallets) in sidebar.
- 2026-01-04 12:00: deployed placement act info summary update to server; restarted fullbox service.
- 2026-01-04 12:05: replaced placement act info block with summary sentence and pluralization.
- 2026-01-04 12:05: deployed placement act info summary sentence to server; restarted fullbox service.
- 2026-01-04 12:13: added server-side validation to require boxes assigned to pallets before closing placement act.
- 2026-01-04 12:14: deployed placement act validation update to server; restarted fullbox service.
- 2026-01-04 12:21: reviewed client_cabinet views, urls, forms, services, and core templates (dashboard, SKU list/form, receiving/packing forms, clients list/form, inventory journal).
- 2026-01-04 12:28: updated client dashboard status/bucket logic for acts and added highlight styling for client-side act cards.
- 2026-01-04 12:28: deployed client dashboard status/highlight changes to server; restarted fullbox service.
- 2026-01-04 12:31: adjusted client dashboard to keep act cards out of the "done" column.
- 2026-01-04 12:31: deployed client dashboard bucket change to server; restarted fullbox service.
- 2026-01-04 12:33: hide client act cards after they are viewed (client can open via order).
- 2026-01-04 12:33: deployed client act visibility change to server; restarted fullbox service.
- 2026-01-04 12:37: fixed client inventory journal filter column indices (SKU/Name/Size dropdowns).
- 2026-01-04 12:38: deployed client inventory journal filter fix to server; restarted fullbox service.
- 2026-01-04 20:11: listed repo root to check structure and searched for AGENTS.md (not found).
- 2026-01-04 20:12: reviewed PROJECT_CONTEXT.md and README.md to refresh project context.
- 2026-01-04 20:25: user asked to record each step; acknowledged and will log actions in this file.
- 2026-01-04 20:38: reviewed client_cabinet backend (views.py, urls.py, forms.py, services.py).
- 2026-01-04 20:38: reviewed client_cabinet templates (dashboard, clients list/form, SKU list/form, receiving/packing/order forms, inventory journal).
- 2026-01-04 20:40: summarized client packing request flow (routes, view handling, payload logging, dashboard status behavior).
- 2026-01-04 20:44: restyled client packing request form template to match receiving form visual style.
- 2026-01-04 20:54: reviewed DEPLOY.md and server_access.md for server connection instructions.
- 2026-01-04 20:54: uploaded updated client packing form template to `/opt/fullbox` on server.
- 2026-01-04 20:54: restarted `fullbox` systemd service on server.
- 2026-01-04 21:00: restyled client packing form to match client cabinet visual design.
- 2026-01-04 21:00: uploaded updated client packing form template to `/opt/fullbox` on server.
- 2026-01-04 21:00: restarted `fullbox` systemd service on server.
- 2026-01-04 21:12: user request on packing form style was ambiguous; asked for clarification before changing.
- 2026-01-04 21:14: reverted client packing form to match receiving form visual style.
- 2026-01-04 21:14: uploaded updated client packing form template to `/opt/fullbox` on server.
- 2026-01-04 21:14: restarted `fullbox` systemd service on server.
- 2026-01-04 21:16: noted where the client receiving request lives (view, template, route).
- 2026-01-04 21:18: checked orders urls/views/templates to confirm receiving form is rendered in orders app (`orders/index.html` via `OrdersHomeView`).
- 2026-01-05 04:56: added packing order support in orders app (views: new packing submit flow, helper formatters, order number per type, packing detail view).
- 2026-01-05 04:56: added packing routes and UI in orders (tabs/heading in `orders/index.html`, packing form markup there, packing detail display in `orders/detail.html`).
- 2026-01-05 04:57: deployed updated orders views/urls/templates to server and restarted `fullbox`.
- 2026-01-05 04:58: clarified that packing uses conditional blocks inside orders templates (no separate template file).
- 2026-01-05 05:05: moved packing form into separate orders template (`orders/packing.html`) and wired OrdersPackingView.
- 2026-01-05 05:05: updated client cabinet links to point packing to `/orders/packing/` and added packing redirect route.
- 2026-01-05 05:06: deployed orders packing template/routes and client cabinet link updates to server; restarted `fullbox`.
- 2026-01-05 05:35: restyled `orders/packing.html` to match client dashboard visual design (palette/layout/sidebar).
- 2026-01-05 05:37: deployed updated `orders/packing.html` to server and restarted `fullbox`.
- 2026-01-05 05:51: trimmed packing sidebar links and moved "В кабинет"/"Журнал заявок" into left nav; deployed and restarted `fullbox`.
- 2026-01-05 05:57: user reported "Доступ запрещен" on client edit page; need to adjust access policy if client self-edit is desired.
- 2026-01-05 05:58: allowed client users to edit their own agency record; deployed and restarted `fullbox`.
- 2026-01-05 06:00: checked audit app; found SKU journal and order journal only, no отдельный журнал клиентов.
- 2026-01-05 06:07: implemented client audit journal (AuditEntry with agency, new list view/template/route, logging on client create/update/archive).
- 2026-01-05 06:07: deployed audit changes, ran migrations (audit/sku/todo), and restarted `fullbox`.
- 2026-01-05 06:08: added client audit logging for Agency changes made via admin; deployed and restarted `fullbox`.
- 2026-01-05 06:12: allowed client users to access INN autofill endpoint; deployed and restarted `fullbox`.
- 2026-01-05 06:20: checked server journalctl/nginx logs for client edit 500; no gunicorn errors found.
- 2026-01-05 06:21: inspected PostgreSQL logs; found missing `audit_auditentry.agency_id` column causing 500 on client save.
- 2026-01-05 06:22: verified Postgres schema missing `agency_id` on `audit_auditentry`.
- 2026-01-05 06:23: applied audit migrations to Postgres with `.env` loaded (previously ran against SQLite).
- 2026-01-05 06:23: rechecked Postgres schema; `audit_auditentry.agency_id` column now present.
- 2026-01-05 06:29: adjusted client edit success redirect for non-staff to stay on `/client/<id>/edit/` instead of staff-only list.
- 2026-01-05 06:29: deployed updated `client_cabinet/views.py` to server and restarted `fullbox`.
- 2026-01-05 06:36: added validation for client requisites form (required INN/phone/FIO, field format checks).
- 2026-01-05 06:36: updated client requisites template labels to mark required fields.
- 2026-01-05 06:36: deployed updated `client_cabinet/forms.py` and `client_cabinet/templates/client_cabinet/clients_form.html`, restarted `fullbox`.
- 2026-01-05 06:41: added phone input mask (+7 with brackets/dashes) and enforced +7 formatting/validation for client requisites form.
- 2026-01-05 06:41: deployed updated `client_cabinet/forms.py` and `client_cabinet/templates/client_cabinet/clients_form.html`, restarted `fullbox`.
- 2026-01-05 06:46: hid client-only buttons ("К списку клиентов", "Dev") on requisites form; cancel now points to client dashboard.
- 2026-01-05 06:46: changed client save redirect to `/client/dashboard/`.
- 2026-01-05 06:46: deployed updated `client_cabinet/views.py` and `client_cabinet/templates/client_cabinet/clients_form.html`, restarted `fullbox`.
- 2026-01-05 06:53: removed client/contact sections from packing form (kept hidden agency/contact fields); deployed and restarted `fullbox`.
- 2026-01-05 07:02: updated `journal.md` with summary of 2026-01-05 changes (packing request, client edit, audit journal, validations).
- 2026-01-07 20:00: updated receiving act flow for clients (redirect to print form, client confirmation/dispute handling, task panel status label) and refreshed `receiving_act_print.html` with client-facing confirmation text and actions.
- 2026-01-07 20:06: adjusted client dashboard to show receiving act card until client responds, even after viewing.
- 2026-01-07 20:24: fixed back navigation for receiving act print (return URL propagation + safe handling) and added dashboard return param to act card links.
- 2026-01-07 20:44: switched placement location to single "Место хранения" (default "Поле приемки"), updated placement UI/validation and inventory journal location display.
- 2026-01-05 07:02: uploaded updated `journal.md` to server.
- 2026-01-05 07:06: added 2026-01-04 summary to `journal.md` and uploaded to server.
- 2026-01-05 07:11: reordered packing request form to start with item description and deadline, moved materials/comment sections; deployed and restarted `fullbox`.
- 2026-01-05 07:18: reworked packing order detail layout to remove right column; moved info/comments under main content for packing; deployed and restarted `fullbox`.
- 2026-01-05 07:25: restored right column for packing detail; info/comments stay in two blocks on the right; deployed and restarted `fullbox`.
- 2026-01-05 07:33: скрыты черновики заявок для не-клиентов в клиентском кабинете и журнале заявок; задеплоены `client_cabinet/views.py` и `orders/views.py`, перезапущен `fullbox`.
- 2026-01-05 07:36: уточнена фильтрация сообщений для не-клиентов (исключены черновики); задеплоен `client_cabinet/views.py`, перезапущен `fullbox`.
- 2026-01-05 07:45: черновики в кабинете/журнале открываются в форме редактирования для клиента; разрешено редактирование черновиков клиентом; задеплоены `client_cabinet/views.py` и `orders/views.py`, перезапущен `fullbox`.
- 2026-01-05 07:49: исправлена ошибка отступов в `orders/views.py` (500 на /orders/); задеплоен файл и перезапущен `fullbox`.
- 2026-01-05 07:55: для клиента разрешен просмотр заказов без параметра `?client=` (берется привязанный portal_user); задеплоен `orders/views.py`, перезапущен `fullbox`.
- 2026-01-05 08:03: добавлены кнопки "Отправить менеджеру" и "Сохранить черновик" в режиме редактирования черновика, отправка меняет статус; задеплоены `orders/views.py` и `orders/templates/orders/index.html`, перезапущен `fullbox`.
- 2026-01-05 08:11: для отправленных заявок на приемку без товаров добавлено спец-имя "Заявка на приемку без указания товара" в карточках/детали; задеплоены `client_cabinet/views.py` и `orders/views.py`, перезапущен `fullbox`.
- 2026-01-06 07:21: listed repo root to find project memory file; searched for memory markers.
- 2026-01-06 07:21: reviewed `README.md` and `PROJECT_CONTEXT.md` to refresh project context.
- 2026-01-06 07:30: updated task display titles to use receiving order payload so empty receiving orders show "Заявка на приемку без указания товара" (todo `models.py`).
- 2026-01-06 07:32: uploaded updated `fullbox/todo/models.py` to `/opt/fullbox` and restarted `fullbox` service.
- 2026-01-06 07:44: updated order title logic for empty receiving orders (orders/client_cabinet/todo), deployed changes, restarted `fullbox`.
- 2026-01-06 08:08: added manual restore prompt for receiving autosave drafts so new orders start clean; deployed updated `orders/index.html`, restarted `fullbox`.
- 2026-01-06 08:19: added client line to order task cards in task panel (todo template tag + `_task_panel.html`), deployed and restarted `fullbox`.
- 2026-01-06 08:26: removed stray todo files on server; highlighted client/status values and shortened "Индивидуальный предприниматель" to "ИП" in task cards; deployed and restarted `fullbox`.
- 2026-01-06 08:28: colored task card status values (waiting red, done green) in `_task_panel.html`, deployed and restarted `fullbox`.
- 2026-01-06 08:40: renamed receiving act creation button to "Взять в работу" in order detail and task detail; deployed and restarted `fullbox`.
- 2026-01-06 08:49: changed receiving act add-item flow to a persistent top entry row with add button; extra items append below; deployed and restarted `fullbox`.
- 2026-01-10 13:18: reviewed repo root, `fullbox/`, `README.md`, and `PROJECT_CONTEXT.md` to familiarize with the project.
- 2026-01-10 13:22: reviewed storekeeper cabinet and streaming receiving flow (orders flow/receiving views and templates).
- 2026-01-10 13:34: updated receiving flow scan highlight color and persistence behavior in `receiving_flow.html`.
- 2026-01-10 13:36: added timed scan highlight auto-clear in receiving flow UI.
- 2026-01-10 13:38: deployed updated `receiving_flow.html` to server and restarted `fullbox` service.
- 2026-01-10 13:44: hid scanner UI block in receiving flow template.
- 2026-01-10 13:44: deployed updated `receiving_flow.html` to server and restarted `fullbox` service.
- 2026-01-10 13:49: changed closed pallets display to chips in receiving flow.
- 2026-01-10 13:50: deployed updated `receiving_flow.html` to server and restarted `fullbox` service.
- 2026-01-10 13:58: added closed pallet context menu with open/print QR actions in receiving flow.
- 2026-01-10 13:59: deployed updated `receiving_flow.html` to server and restarted `fullbox` service.
- 2026-01-10 14:49: enforced single open pallet when opening a closed pallet in receiving flow.
- 2026-01-10 14:51: deployed updated `receiving_flow.html` to server and restarted `fullbox` service.
- 2026-01-10 15:07: removed active pallet/box pills from receiving flow header.
- 2026-01-10 15:09: deployed updated `receiving_flow.html` to server and restarted `fullbox` service.
- 2026-01-10 15:12: moved pallet close/finish buttons into pallets block in receiving flow.
- 2026-01-10 15:13: deployed updated `receiving_flow.html` to server and restarted `fullbox` service.
- 2026-01-06 08:54: updated receiving act page title/header to "В работе ..." using order title derived from payload; deployed and restarted `fullbox`.
- 2026-01-06 09:03: added SKU/barcode columns to receiving act table with backend lookup and extra-item fields; deployed and restarted `fullbox`.
- 2026-01-06 09:17: added SKU/barcode/name datalist suggestions for receiving act entry fields; deployed and restarted `fullbox`.
- 2026-01-06 09:21: listed repo root, searched for memory markers, reviewed `PROJECT_CONTEXT.md` and `README.md` to refresh project context and confirm memory file.
- 2026-01-06 09:24: searched for barcode/scanner references and reviewed `fullbox/templates/scanner_test.html` plus `fullbox/orders/templates/orders/receiving_act.html` to prep scanner troubleshooting.
- 2026-01-06 09:27: updated head manager dashboard scanner link to "Настройка сканеров" (points to `/scanner-test/`).
- 2026-01-06 09:31: added `/scanner-settings/` route and new `scanner_settings.html` page; updated head manager dashboard link to new settings page.
- 2026-01-06 09:37: deployed updated head manager dashboard, new scanner settings template, and `fullbox/fullbox/urls.py` to server; restarted `fullbox`.
- 2026-01-06 09:53: added Web Serial (COM) connect UI + read loop to `scanner_settings.html`, updated instructions, deployed template, restarted `fullbox`.
- 2026-01-06 10:13: added Proton IMS-2290HD_K guidance and COM control-char display to `scanner_settings.html`; deployed template, restarted `fullbox`.
- 2026-01-06 11:15: added Proton IMS-2290HD_K dedicated page with barcode instructions, new route and button, added static barcode images, updated static settings; deployed templates/settings/static to server and restarted `fullbox`.
- 2026-01-06 11:21: embedded IMS-2290HD_K barcode images as data URIs in `scanner_ims_2290hd.html`, fixed scanner settings text, redeployed templates, restarted `fullbox`.
- 2026-01-06 12:07: troubleshooting scanner COM/VCP; identified USB port issue (scanner started working on different USB port).
- 2026-01-06 13:18: added barcode scan support to receiving act page (scanner UI, barcode->SKU map, auto-add/increment, unknown barcode link to SKU) in `orders/views.py` and `orders/templates/orders/receiving_act.html`.
- 2026-01-06 14:13: added "Настройка сканеров" link to storekeeper dashboard nav (`sklad/templates/sklad/dashboard.html`) pointing to `/scanner-settings/`.
- 2026-01-06 14:17: made scanner settings "В кабинет" button return to referrer when available (`templates/scanner_settings.html`).
- 2026-01-06 14:31: rendered barcode as SVG in client SKU card view using JsBarcode; updated `client_cabinet/templates/client_cabinet/client_sku_list.html`.
- 2026-01-06 15:15: allow receiving act save when planned items are empty but extra scanned items exist; keep mismatch logic only for planned items (`orders/views.py`).
- 2026-01-06 15:21: prevent Enter key in act inputs from submitting form (scanner/text inputs won’t auto-save act) in `orders/templates/orders/receiving_act.html`.
- 2026-01-06 15:37: journal list now shows actual qty for receiving orders after acceptance (added totals from act items in `orders/views.py`, column in `orders/templates/orders/index.html`).
- 2026-01-06 15:44: receiving order detail now shows actual qty from act (falls back to act items when no planned items) in `orders/views.py` and `orders/templates/orders/detail.html`.
- 2026-01-06 16:15: client dashboard messages now use full order titles and the messages panel scrolls (`client_cabinet/views.py`, `client_cabinet/templates/client_cabinet/dashboard.html`); deployed and restarted `fullbox`.
- 2026-01-06 16:31: increased client dashboard messages list to 30 items (`client_cabinet/views.py`); deployed and restarted `fullbox`.
- 2026-01-06 17:09: removed packing tab/button from client view in orders list/receiving (`orders/templates/orders/index.html`); deployed and restarted `fullbox`.
- 2026-01-06 17:13: removed journal and receiving tabs from client view in orders pages header (`orders/templates/orders/index.html`); deployed and restarted `fullbox`.
- 2026-01-06 17:24: wired receiving "Скачать шаблон" button to download receiving + SKU upload templates from new static docs (`orders/templates/orders/index.html`, `static/docs`); deployed and restarted `fullbox`.
- 2026-01-06 17:28: fixed static download URLs to use absolute `/static/...` paths on receiving template download button (`orders/templates/orders/index.html`); deployed and restarted `fullbox`.
- 2026-01-06 17:33: added Django download endpoints for receiving/SKU templates and switched "Скачать шаблон" to those URLs (`orders/views.py`, `orders/urls.py`, `orders/templates/orders/index.html`); deployed and restarted `fullbox`.
- 2026-01-06 17:42: added upload modal for filled templates on receiving form (modal UI + file input attached to form, JS open/close, file list) in `orders/templates/orders/index.html`; deployed and restarted `fullbox`.
- 2026-01-06 17:45: updated `journal.md` with 2026-01-05 and 2026-01-06 work summary entries; deployed to server.
- 2026-01-06 18:48: receiving template upload now accepts only SKU/receiving templates; SKU template adds SKUs first, receiving template adds order items only from catalog, with new backend parsing logic and modal text updates (`orders/views.py`, `orders/templates/orders/index.html`); deployed and restarted `fullbox`.
- 2026-01-06 18:55: template upload modal now has separate file inputs for SKU vs receiving templates with client-facing descriptions; backend accepts both fields (`orders/views.py`, `orders/templates/orders/index.html`); deployed and restarted `fullbox`.
- 2026-01-06 19:05: storekeeper dashboard task board no longer stretches columns; switched to content-height layout with scroll on main content (`sklad/templates/sklad/dashboard.html`); deployed and restarted `fullbox`.
- 2026-01-06 19:10: storekeeper dashboard task columns now capped to viewport with internal scroll; task cards stay compact (`sklad/templates/sklad/dashboard.html`); deployed and restarted `fullbox`.
- 2026-01-06 19:33: receiving act now detects fast scanner input and routes it to the scan field even when focus is elsewhere (keyboard-wedge heuristic), without affecting manual typing (`orders/templates/orders/receiving_act.html`); deployed and restarted `fullbox`.
- 2026-01-06 19:46: relaxed scan heuristic timing for keyboard-wedge input to capture full barcode strings (gap/avg/total thresholds) in `orders/templates/orders/receiving_act.html`; deployed and restarted `fullbox`.
- 2026-01-06 19:51: reworked scan heuristic to avoid truncation (no per-char preventDefault, larger gaps, only intercept on terminator) in `orders/templates/orders/receiving_act.html`; deployed and restarted `fullbox`.
- 2026-01-06 19:54: disabled global scanner heuristic when scan input is focused and restored direct Enter handling on scan field (`orders/templates/orders/receiving_act.html`); deployed and restarted `fullbox`.
- 2026-01-06 22:36: added automatic act document generation (receiving act + МХ-1), download endpoints, and links in receiving act UI; added template xlsx files under `static/docs` (`orders/views.py`, `orders/urls.py`, `orders/templates/orders/receiving_act.html`, `static/docs`); deployed and restarted `fullbox`.
- 2026-01-07 08:12: cleared unused template rows in act documents and forced regeneration on download to remove sample positions (`orders/views.py`); deployed and restarted `fullbox`.
- 2026-01-07 08:17: avoid writing into merged cells while clearing act templates (prevents 500 on download) in `orders/views.py`; deployed and restarted `fullbox`.
- 2026-01-07 08:24: act document generation now deletes unused item rows so only actual items remain (no sample/blank rows) for receiving act and MX-1 sheets (`orders/views.py`); deployed and restarted `fullbox`.
- 2026-01-07 08:35: wired placement payload into act document generation so box quantities can fill receiving act columns; deployed and restarted `fullbox` (`orders/views.py`).
- 2026-01-07 08:43: reviewed project docs (`README.md`, `PROJECT_CONTEXT.md`, `description.md`, `note.txt`), searched for "вспоин/споин" and apex/fastapi references, inspected Django root routes and FastAPI entry (`fullbox/fullbox/urls.py`, `nb/FApiT.py`) to locate the requested file.
- 2026-01-07 08:48: reviewed storekeeper receiving act route/view/template for `/orders/receiving/<id>/act/` (`fullbox/orders/urls.py`, `fullbox/orders/views.py`, `fullbox/orders/templates/orders/receiving_act.html`).
- 2026-01-07 08:53: acknowledged renaming the receiving act document label to "акт приемки печатная форма" per request; pending implementation.
- 2026-01-07 08:54: renamed receiving act document button label to "Акт приемки печатная форма" and deployed updated `fullbox/orders/views.py`, restarted `fullbox` service.
- 2026-01-07 09:02: added printable receiving act page (`fullbox/orders/templates/orders/receiving_act_print.html`), wired new print route and updated act button URL (`fullbox/orders/views.py`, `fullbox/orders/urls.py`).
- 2026-01-07 09:03: deployed receiving act print changes to server (views/urls/template), corrected template path on server, restarted `fullbox` service.
- 2026-01-07 09:25: adjusted receiving act print layout to match spreadsheet sample and count boxes by number of boxes, deployed updated `fullbox/orders/views.py` and `fullbox/orders/templates/orders/receiving_act_print.html`, restarted `fullbox` service.
- 2026-01-07 09:30: added bottom signature/summary block to receiving act print and switched total boxes/pallets to unique counts from placement payload, deployed updated `fullbox/orders/views.py` and `fullbox/orders/templates/orders/receiving_act_print.html`, restarted `fullbox` service.
- 2026-01-07 10:06: added printable MХ-1 page (HTML template + route), wired MХ-1 button to print view, included per-item boxes/pallets and page splitting (`fullbox/orders/views.py`, `fullbox/orders/urls.py`, `fullbox/orders/templates/orders/mx1_print.html`).
- 2026-01-07 10:20: reworked MХ-1 print layout to match sample form (header blocks, codes, contract, act block, column numbering), adjusted item mapping and page size (`fullbox/orders/views.py`, `fullbox/orders/templates/orders/mx1_print.html`).
- 2026-01-07 10:23: added "Артикул" column to receiving act print and separated SKU from item name (`fullbox/orders/views.py`, `fullbox/orders/templates/orders/receiving_act_print.html`).
- 2026-01-07 10:36: updated receiving act print title to "Акт приемки" and adjusted column widths (wider name, narrower barcode), deployed template and restarted `fullbox`.
- 2026-01-07 10:42: added "Сотрудники" navigation link to head manager dashboard (`fullbox/templates/head_manager/dashboard.html`).
- 2026-01-07 10:42: deployed updated head manager dashboard and restarted `fullbox` service.
- 2026-01-07 10:47: added head manager employee edit view + template and edit links, deployed `fullbox/employees/views.py`, `fullbox/employees/urls.py`, `fullbox/employees/templates/employees/employee_list.html`, `fullbox/employees/templates/employees/employee_form.html`, restarted `fullbox`.
- 2026-01-07 10:57: restyled employees list/edit pages to match head manager cabinet and removed Dev/Admin buttons, deployed updated `fullbox/employees/views.py`, `fullbox/employees/templates/employees/employee_list.html`, `fullbox/employees/templates/employees/employee_form.html`, restarted `fullbox`.
- 2026-01-07 11:03: expanded employees list/edit pages to full-width layout, deployed updated `fullbox/employees/templates/employees/employee_list.html` and `fullbox/employees/templates/employees/employee_form.html`, restarted `fullbox`.
- 2026-01-07 11:15: added employee facsimile upload (PNG normalization), wired facsimile into receiving act and MX-1 print templates, updated settings and requirements, deployed, ran migrations, installed Pillow, restarted `fullbox`.
- 2026-01-07 11:26: applied facsimile migration to production DB with env loaded and restarted `fullbox` to fix missing column error.
- 2026-01-07 11:33: ensured facsimile normalization runs on new uploads and added facsimile preview column to employees list; deployed and restarted `fullbox`.
- 2026-01-07 11:39: fixed media access for facsimile previews by opening permissions on `/opt/fullbox/fullbox/media` and parent folder; verified `/media/` returns 200 from nginx.
- 2026-01-07 11:43: set employees list/edit pages background to white; deployed and restarted `fullbox`.
- 2026-01-07 11:45: set facsimile preview background to white on employees list/edit pages; deployed and restarted `fullbox`.
- 2026-01-07 11:47: boosted facsimile preview visibility with CSS contrast/brightness filters; deployed and restarted `fullbox`.
- 2026-01-07 11:49: adjusted facsimile preview to darker tone for better visibility on white background; deployed and restarted `fullbox`.
- 2026-01-07 11:51: increased facsimile preview darkness (contrast 1.7, brightness 0.65) to improve visibility; deployed and restarted `fullbox`.
- 2026-01-07 18:55: added new `stockmap` app with storekeeper access and "Карта склада" button, plus stockmap table template; deployed and restarted `fullbox`.
- 2026-01-07 19:03: expanded stockmap table with free/occupied columns and full-width layout; deployed and restarted `fullbox`.
- 2026-01-07 19:07: updated stockmap capacity to compute total cells per row as sections * tiers * cells per tier; deployed and restarted `fullbox`.
- 2026-01-07 19:18: added OS row detail page with rack view (sections/tiers/cells) and linked row numbers in stockmap table; deployed and restarted `fullbox`.
- 2026-01-07 19:21: removed "Ярус" label and tightened rack layout to fit more sections on screen; deployed and restarted `fullbox`.
- 2026-01-07 11:39: reviewed `README.md`, `description.md`, and `PROJECT_CONTEXT.md` to refresh project overview.
- 2026-01-07 11:41: reviewed `fullbox/sku/models.py` to list client (Agency) fields.
- 2026-01-07 11:48: checked local SQLite `fullbox/db.sqlite3` for Agency pref заполненность (counts and sample rows).
- 2026-01-07 11:58: queried production Postgres on server for Agency pref заполненность (counts).
- 2026-01-07 12:07: updated receiving order detail items mapping to include extra act positions in `fullbox/orders/views.py`.
- 2026-01-07 12:07: deployed updated `fullbox/orders/views.py` to server and restarted `fullbox` service.
- 2026-01-07 12:22: added receiving act signing workflow (storekeeper/manager) and locked edits after storekeeper signature; updated `fullbox/orders/views.py`, `fullbox/orders/urls.py`, `fullbox/orders/templates/orders/receiving_act_print.html`.
- 2026-01-07 12:22: deployed updated orders views/urls/receiving act print template to server and restarted `fullbox`.
- 2026-01-07 12:34: added back button to receiving act print, gated print/signing on closed placement, and hid print buttons until placement closed (`fullbox/orders/views.py`, `fullbox/orders/urls.py`, `fullbox/orders/templates/orders/receiving_act_print.html`, `fullbox/orders/templates/orders/receiving_act.html`).
- 2026-01-07 12:34: deployed updated orders views/urls/templates to server and restarted `fullbox`.
- 2026-01-07 12:44: blocked reopening placement act after storekeeper signature, gated act downloads on closed placement, and updated placement act UI message (`fullbox/orders/views.py`, `fullbox/orders/templates/orders/placement_act.html`).
- 2026-01-07 12:44: deployed updated placement act view/template to server and restarted `fullbox`.
- 2026-01-07 13:22: hid MХ-1 print link for storekeeper view on receiving act page (`fullbox/orders/views.py`).
- 2026-01-07 13:22: deployed updated orders views to server and restarted `fullbox`.
- 2026-01-07 13:32: added manager sign task creation on storekeeper signature and updated order status label; close sign task on manager signature (`fullbox/orders/views.py`).
- 2026-01-07 13:32: deployed updated orders views to server and restarted `fullbox`.
- 2026-01-07 18:27: added status label override for signed receiving acts and auto-create manager sign task on print view (`fullbox/orders/views.py`).
- 2026-01-07 18:27: deployed updated orders views to server and restarted `fullbox`.
- 2026-01-07 18:47: backfilled manager sign task for order 5 in production DB.
- 2026-01-07 18:49: remove manager sign task after successful manager signature to hide it from dashboard (`fullbox/orders/views.py`).
- 2026-01-07 18:49: deployed updated orders views to server and restarted `fullbox`.
- 2026-01-07 18:55: show storekeeper-signed status in task board and keep sign tasks separate with explicit title (`fullbox/todo/templatetags/todo_panel.py`, `fullbox/todo/templates/todo/_task_panel.html`).
- 2026-01-07 18:55: deployed updated todo panel code to server and restarted `fullbox`.
- 2026-01-07 19:06: made task cards compact (no stretch) and limited attention highlight to act sign tasks (`fullbox/todo/templates/todo/_task_panel.html`).
- 2026-01-07 19:06: deployed updated task panel template and restarted `fullbox`.
- 2026-01-07 19:24: styled main stock row links as buttons in stockmap overview (`fullbox/stockmap/templates/stockmap/stockmap.html`).
- 2026-01-07 19:24: deployed updated stockmap template to server; `fullbox` service active after restart.
- 2026-01-07 20:57: switched placement act location to zone codes (default PR + suggestions), normalized legacy location values to PR/OS, and renamed inventory journal column to "Зона"; deployed and restarted `fullbox`.
- 2026-01-07 21:05: replaced zone input with a dropdown to show PR/OS choices immediately; deployed and restarted `fullbox`.
- 2026-01-07 21:12: expanded placement zone options to PR/OT/MR/OS and normalized new zone names in orders/sklad views; deployed and restarted `fullbox`.
- 2026-01-07 21:48: added MR/OS dependent fields in placement act (row/section/tier/cell) with occupied-cell blocking, and normalized OTG zone labels; deployed and restarted `fullbox`.
- 2026-01-07 21:56: wired stockmap occupancy to placement acts (OS row view + counts), including MR row occupancy totals; deployed and restarted `fullbox`.
- 2026-01-07 22:48: cleared all order audit entries and tasks from production DB and removed act/task_files from media to reset stockmap occupancy.
- 2026-01-08 06:25: auto-restore receiving draft when returning from SKU list to avoid form reset prompt; deployed template update.
- 2026-01-08 06:44: fixed client receiving draft restore after SKU list by auto-restoring when cart items exist and setting return flag on SKU list; deployed templates and restarted `fullbox`.
- 2026-01-08 15:50: reviewed README/description and core Django settings/urls plus key app models/views (orders, audit, sku, todo) to understand project structure.
- 2026-01-08 15:55: replaced "Дашборд/Dev" buttons with "В кабинет" on clients list and wired cabinet URL into view context.
- 2026-01-08 15:57: uploaded updated client list template/view to server and restarted `fullbox` service.
- 2026-01-08 22:09: added placement act barcode scan support (barcode map + scan UI/logic to add item into active box).
- 2026-01-08 22:09: uploaded placement act scan updates to server and restarted `fullbox` service.
- 2026-01-09 08:23: listed repo root and searched for AGENTS.md (not found).
- 2026-01-09 08:23: reviewed `README.md`, `PROJECT_CONTEXT.md`, and `description.md` to refresh project context.
- 2026-01-09 08:24: located team manager routing and access, reviewed `teammanager` view/urls and dashboard template.
- 2026-01-09 10:28: adjusted receiving flow scan/manual input handling to ignore scanner digits in "В короб" field and preserve manual values; deployed template and restarted `fullbox`.
- 2026-01-09 21:14: updated receiving flow close logic to delete empty boxes/pallets and auto-close open boxes when closing a pallet (`fullbox/orders/templates/orders/receiving_flow.html`).
- 2026-01-09 21:17: deployed updated receiving flow template to server and restarted `fullbox`.
- 2026-01-09 21:58: allowed finishing receiving flow with mismatches (confirm prompt), deployed updated template and restarted `fullbox`.
- 2026-01-09 22:07: finalize receiving flow now seals open containers and removes empty boxes/pallets on submit; deployed template and restarted `fullbox`.
- 2026-01-10 07:14: fixed inventory journal to return empty list for clients without their own receiving entries (avoid showing other clients' stock), deployed `fullbox/sklad/views.py`, restarted `fullbox`.
- 2026-01-10 07:24: added goods type "Не обработанный" (no) in receiving flow selection and labels, deployed `fullbox/orders/views.py` and `fullbox/orders/templates/orders/detail.html`, restarted `fullbox`.
- 2026-01-10 07:40: restyled current box panel in receiving flow with split layout and large close button, highlighted quantities, deployed template and restarted `fullbox`.
- 2026-01-10 07:47: keep focus in "В короб" input after closing box in receiving flow, deployed template and restarted `fullbox`.
- 2026-01-10 07:53: constrained closed boxes panel with scroll and newest-first ordering in receiving flow, deployed template and restarted `fullbox`.
- 2026-01-10 08:14: added print button for current box label (58x60) next to "Убрать лишнее" with print preview, deployed receiving flow template and restarted `fullbox`.
- 2026-01-10 08:18: fixed receiving flow JS break by removing inline </script> from print preview HTML, redeployed template and restarted `fullbox`.
- 2026-01-10 08:53: added QR code to current box print label preview (receiving flow), deployed template and restarted `fullbox`.
- 2026-01-10 08:56: resized box label code text and QR image to fit without wrapping, redeployed receiving flow template and restarted `fullbox`.
- 2026-01-10 09:05: embedded QR generation for box label via local qrcodejs (no external QR fetch), deployed template and static vendor script, restarted `fullbox`.
- 2026-01-10 09:18: switched box label print preview to generate QR inside the print window (qrcodejs) and show error text if QR fails; redeployed template and restarted `fullbox`.
- 2026-01-10 09:25: fixed QR loader to use absolute script URL in print preview, redeployed receiving flow template and restarted `fullbox`.
- 2026-01-10 09:29: copied qrcode.min.js into staticfiles so /static/vendor/qrcode.min.js serves 200 (QR print preview).
- 2026-01-10 09:34: generate QR data URL in main window before print preview (ensure QR lib load), embedded QR image in print HTML, redeployed template and restarted `fullbox`.
- 2026-01-10 09:38: opened print preview window synchronously to avoid popup blocking; QR generation runs after lib load, redeployed template and restarted `fullbox`.
- 2026-01-10 09:42: render QR data URL asynchronously with retry and show placeholder in print preview before printing, redeployed template and restarted `fullbox`.
- 2026-01-10 09:54: reverted to generating QR inside print preview window using qrcodejs script, with placeholder fallback, redeployed template and restarted `fullbox`.
- 2026-01-10 09:58: generate QR data URL in main window after ensuring qrcodejs, inject QR image into print preview, redeployed template and restarted `fullbox`.
- 2026-01-10 10:18: render box label QR directly in print preview by loading qrcodejs inside the preview window, add fallback message for missing box; deployed template and restarted `fullbox`.
- 2026-01-10 10:32: wait for print preview DOM ready before loading qrcodejs and rendering QR, then print; deployed template and restarted `fullbox`.
- 2026-01-10 10:42: added QR preview column in current box panel and render QR immediately in main window on box change; deployed template and restarted `fullbox`.
- 2026-01-10 10:49: removed QR header text, reduced QR preview size to avoid expanding current box panel, and added dynamic loader for qrcodejs in main flow view; deployed template and restarted `fullbox`.
- 2026-01-10 11:30: reviewed repo structure and core docs (`README.md`, `PROJECT_CONTEXT.md`, `description.md`, `DEPLOY.md`, `LABEL_PRINT.md`) plus Django settings/urls/manage entrypoints to refresh project understanding.
- 2026-01-10 11:36: reviewed storekeeper streaming receiving entrypoints and UI (orders detail link, `/orders/receiving/<id>/flow/`, `ReceivingFlowView`, and `receiving_flow.html`) to explain the workflow.
- 2026-01-10 11:44: inspected receiving flow QR rendering path and local `qrcode.min.js` asset to diagnose missing QR preview.
- 2026-01-10 11:46: added console logging around receiving flow QR load/render to surface missing lib or render errors.
- 2026-01-10 12:01: patched local `qrcode.min.js` to reset UTF-8 byte buffer per char (fixes QR overflow on Cyrillic).
- 2026-01-10 12:11: added pallet numbering in flow UI and prefixed closed box codes with pallet/box numbers.
- 2026-01-10 12:40: added box context menu in receiving flow (view/edit/delete), server logging to new audit journal, and head manager link to the new journal.
- 2026-01-10 12:59: removed per-row "В короб" button from receiving flow items table; keep input-only entry.
- 2026-01-10 13:02: highlighted remaining items rows in green when planned qty equals actual qty.
- 2026-01-10 13:11: enforced single open pallet by closing current pallet when editing a box in another pallet (empty pallet removed).
- 2026-01-10 15:40: added catalog-backed add row for unplaced items in receiving flow (datalist, extra-item ordering, and seeding from existing boxes) plus catalog items JSON in the template.
- 2026-01-10 15:41: deployed receiving flow add-row/catalog updates (`fullbox/orders/views.py`, `fullbox/orders/templates/orders/receiving_flow.html`) and restarted `fullbox`.
- 2026-01-10 15:50: split add-row inputs into separate SKU/name/size fields with individual dropdown lists in receiving flow.
- 2026-01-10 15:50: deployed receiving flow add-row field split update (`fullbox/orders/templates/orders/receiving_flow.html`) and restarted `fullbox`.
- 2026-01-10 15:59: auto-fill SKU/name/size in add-row based on a matching catalog item and allow selection with single-field input.
- 2026-01-10 16:00: deployed add-row auto-fill tweak (`fullbox/orders/templates/orders/receiving_flow.html`) and restarted `fullbox`.
- 2026-01-10 17:39: kept receiving flow completion on flow page and adjusted status label logic for "Товар принят (с расхождениями)" (`fullbox/orders/views.py`).
- 2026-01-10 17:40: deployed receiving flow completion/status update (`fullbox/orders/views.py`) and restarted `fullbox`.
- 2026-01-10 17:52: updated receiving flow completion to lock with flow_closed, add reopen action logging, status label, and act print link (`fullbox/orders/views.py`, `fullbox/orders/templates/orders/receiving_flow.html`).
- 2026-01-10 17:53: deployed receiving flow completion/reopen updates and restarted `fullbox`.
- 2026-01-10 17:59: hide current box section and open pallets when flow is closed in receiving flow UI (`fullbox/orders/templates/orders/receiving_flow.html`).
- 2026-01-10 18:00: deployed flow-closed UI cleanup (`fullbox/orders/templates/orders/receiving_flow.html`) and restarted `fullbox`.
- 2026-01-10 18:18: hid "Новая приемка" and "Упаковка" buttons on orders journal page (`fullbox/orders/templates/orders/index.html`).
- 2026-01-10 18:19: deployed orders journal header change (`fullbox/orders/templates/orders/index.html`) and restarted `fullbox`.
- 2026-01-10 18:34: force opening pallets/boxes when adding via scanner or manual add row in flow (`fullbox/orders/templates/orders/receiving_flow.html`).
- 2026-01-10 18:35: deployed flow scanner/open-container tweak (`fullbox/orders/templates/orders/receiving_flow.html`) and restarted `fullbox`.
- 2026-01-10 19:03: adjusted flow auto-open logic to treat extra (qty=0) items as remaining (`fullbox/orders/templates/orders/receiving_flow.html`).
- 2026-01-10 19:04: deployed auto-open tweak for extra items and restarted `fullbox`.
- 2026-01-10 19:12: set flow act print link to return back to flow (`fullbox/orders/views.py`).
- 2026-01-10 19:13: deployed flow act print return link update (`fullbox/orders/views.py`) and restarted `fullbox`.
- 2026-01-10 20:01: fixed login redirect for already-authenticated client users (`fullbox/fullbox/views.py`).
- 2026-01-10 20:02: deployed login redirect fix (`fullbox/fullbox/views.py`) and restarted `fullbox`.
- 2026-01-10 22:15: added processing order type (views/urls), client cabinet button, and processing template with detailed fields (`fullbox/orders/views.py`, `fullbox/orders/urls.py`, `fullbox/orders/templates/orders/processing.html`, `fullbox/orders/templates/orders/detail.html`, `fullbox/client_cabinet/views.py`, `fullbox/client_cabinet/templates/client_cabinet/dashboard.html`).
- 2026-01-10 22:20: deployed processing order changes (orders/client cabinet templates/views) and restarted `fullbox` service.
- 2026-01-10 22:30: trimmed client-side nav in processing order page to only cabinet + stock links (`fullbox/orders/templates/orders/processing.html`).
- 2026-01-10 22:31: deployed processing nav trim and restarted `fullbox` service.
- 2026-01-10 22:45: restructured processing form into 2x2 grid with only product info in top-left and photo placeholder (`fullbox/orders/templates/orders/processing.html`).
- 2026-01-10 22:46: deployed processing grid layout update and restarted `fullbox` service.
