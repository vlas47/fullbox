<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title }} | FULLBOX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  {% load widget_tweaks %}
  <style>
    :root { --bg:#0b0b0f; --card:#14141f; --gold:#d6a300; --gold-soft:#e7c34a; --text:#e8e8ed; --muted:#9aa0b3; --stroke: rgba(255,255,255,0.08); }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:'Space Grotesk',system-ui,sans-serif; }
    a { color: inherit; text-decoration: none; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 28px 18px 64px; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    h1 { margin:0; letter-spacing:-0.5px; }
    .muted { color: var(--muted); }
    .controls { display:flex; gap:10px; flex-wrap:wrap; }
    .btn { padding:10px 14px; border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,0.02); color:var(--text); font-weight:600; }
    .btn:hover { border-color: var(--gold); box-shadow:0 10px 25px rgba(214,163,0,0.25); }
    .btn.primary { background: linear-gradient(120deg,var(--gold),var(--gold-soft)); color: var(--bg); border-color: transparent; }
    .card { background:var(--card); border:1px solid var(--stroke); border-radius:16px; padding:16px; box-shadow:0 18px 45px rgba(0,0,0,0.35); }
    form { display:grid; gap:12px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; }
    label { display:block; font-weight:600; margin-bottom:6px; color:var(--muted); }
    input, select, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,0.03); color:var(--text); }
    textarea { resize:vertical; }
    .row { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:10px; border:1px solid var(--stroke); background:rgba(255,255,255,0.05); }
    .section { border:1px solid var(--stroke); border-radius:14px; padding:12px; }
    .section h3 { margin:0 0 10px; }
    .field-error { border-color: var(--gold-soft); box-shadow: 0 0 0 1px rgba(231,195,74,0.4); background:rgba(231,195,74,0.08); }
    .modal { position:fixed; inset:0; background:rgba(5,6,10,0.7); display:none; align-items:center; justify-content:center; padding:24px; z-index:30; }
    .modal.active { display:flex; }
    .modal-card { width:min(1120px, 98vw); background:var(--card); border:1px solid var(--stroke); border-radius:18px; padding:18px; box-shadow:0 25px 60px rgba(0,0,0,0.45); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px; }
    .printer-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
    .printer-row label { color:var(--muted); font-weight:600; }
    .printer-row input { min-width:240px; }
    .label-mode { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .label-stage { --label-scale: 3; position:relative; background:rgba(255,255,255,0.02); border:1px dashed var(--stroke); border-radius:14px; padding:18px; display:flex; justify-content:center; align-items:center; min-height:320px; overflow:visible; }
    .label-size-badge {
      position:absolute;
      top:12px;
      right:14px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,0.04);
      color:var(--muted);
      font-size:12px;
      font-weight:600;
      letter-spacing:0.2px;
    }
    .label-preview {
      background:#ffffff;
      color:#111;
      border:1px solid #d4d4d4;
      border-radius:4px;
      width:35mm;
      height:20mm;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(3, 1fr);
      position:relative;
      zoom: var(--label-scale);
      background-image: none;
    }
    .label-preview.no-cz .label-barcode-cell,
    .label-preview.no-cz .label-info-cell,
    .label-preview.no-cz .label-qr-cell,
    .label-preview.no-cz .label-eac { display:none; }
    .label-no-cz-grid {
      position:absolute;
      inset:0;
      display:none;
      grid-template-rows: repeat(4, 1fr);
    }
    .label-no-cz-row { border-bottom:1px solid #d4d4d4; }
    .label-no-cz-row:last-child { border-bottom:none; }
    .label-no-cz-text {
      padding:0.6mm 0.8mm;
      display:flex;
      flex-direction:column;
      gap:0.3mm;
      font-size:0.9mm;
      line-height:1.1;
      color:#111;
    }
    .label-no-cz-line { display:flex; gap:0.4mm; flex-wrap:wrap; }
    .label-no-cz-label { font-weight:600; }
    .label-no-cz-article {
      font-size:2em;
      font-weight:700;
      line-height:1.05;
    }
    .label-no-cz-name {
      font-size:2em;
      font-weight:500;
      line-height:1.05;
    }
    .label-no-cz-row-split {
      display:flex;
    }
    .label-no-cz-row-split .label-no-cz-article {
      font-size:0.4em;
      font-weight:700;
      line-height:1.05;
    }
    .label-no-cz-row-split [data-no-cz="size"] {
      font-size:0.8em;
    }
    .label-no-cz-split {
      flex:1;
      padding:0.6mm 0.8mm;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
    }
    .label-no-cz-split + .label-no-cz-split {
      border-left:1px solid #d4d4d4;
    }
    .label-no-cz-barcode {
      display:flex;
      align-items:stretch;
      justify-content:stretch;
    }
    .label-no-cz-barcode-wrap {
      flex:1;
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:stretch;
      justify-content:center;
      gap:0.4mm;
    }
    .label-no-cz-barcode-svg {
      width:100%;
      height:6mm;
      display:block;
    }
    .label-no-cz-barcode-value {
      font-size:0.95mm;
      line-height:1;
      letter-spacing:0.2mm;
      color:#111;
      white-space:nowrap;
      text-align:center;
    }
    .label-preview.no-cz .label-no-cz-grid { display:grid; }
    .label-barcode-cell {
      grid-column: 1;
      grid-row: 1 / span 3;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .label-qr-cell {
      grid-column: 4 / span 2;
      grid-row: 1 / span 2;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .label-qr {
      width:12.5mm;
      height:12.5mm;
      border:1px solid #111;
      display:grid;
      place-items:center;
      overflow:hidden;
      background:#fff;
    }
    .label-qr canvas,
    .label-qr img {
      width:100% !important;
      height:100% !important;
      display:block;
    }
    .label-eac {
      position:absolute;
      right:0.6mm;
      bottom:0.6mm;
      width:3mm;
      height:auto;
      display:block;
    }
    .label-eac img {
      width:100%;
      height:auto;
      display:block;
    }
    .label-info-cell {
      grid-column: 2 / span 2;
      grid-row: 1 / span 3;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:0.6mm 0.4mm;
      overflow:hidden;
    }
    .label-info {
      width:100%;
      display:flex;
      flex-direction:column;
      gap:0.4mm;
      font-size:0.9mm;
      line-height:1.05;
      color:#111;
      height:100%;
      justify-content:space-between;
    }
    .label-info-emph {
      font-size:1mm;
    }
    .label-info-top {
      display:flex;
      flex-direction:column;
      gap:0.35mm;
      border-bottom:1px solid rgba(0,0,0,0.2);
      padding-bottom:0.35mm;
      min-height:3mm;
      flex:1 1 auto;
    }
    .label-info-line {
      white-space:normal;
      word-break:break-word;
    }
    .label-info-bottom {
      display:flex;
      flex-direction:column;
      gap:0.3mm;
      padding-top:0.25mm;
      flex:0 0 auto;
    }
    .label-info-label {
      font-weight:700;
      margin-right:0.2mm;
    }
    .label-barcode-rotate {
      position:absolute;
      top:50%;
      left:50%;
      width:18mm;
      height:6mm;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:0.2mm;
      transform: translate(-50%, -50%) rotate(90deg);
      transform-origin:center;
    }
    .label-barcode {
      width:100%;
      height:4.2mm;
      display:block;
    }
    .label-barcode-value {
      font-size:0.9mm;
      line-height:1;
      letter-spacing:0.15mm;
      color:#111;
      white-space:nowrap;
    }
    .modal-actions { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    @media print {
      body { margin:0; }
      body > *:not(#label-preview) { display:none !important; }
      #label-preview { display:block !important; position:static; inset:auto; background:none; padding:0; }
      #label-preview, #label-preview * { visibility:visible; }
      #label-preview .modal-card { box-shadow:none; border:none; padding:0; width:auto; }
      #label-preview .modal-header, #label-preview .modal-actions { display:none; }
      #label-preview .printer-row { display:none; }
      #label-preview .label-mode { display:none; }
      #label-preview .label-size-badge { display:none; }
      #label-preview .label-stage { border:none; padding:0; min-height:auto; --label-scale: 1 !important; }
    }
    {% include "labels/_label_styles.css" %}
    @media (max-width: 900px) {
      .label-stage { --label-scale: 2.4; min-height:260px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="muted">FULLBOX · {% include "partials/current_user.html" %}</div>
        <h1>{{ title }}</h1>
      </div>
      <div class="controls">
        <a class="btn" href="#" id="label-preview-open">Печать этикетки</a>
        <a class="btn" href="{{ request.GET.next|default:'/sku/' }}">К списку SKU</a>
        <a class="btn" href="/dev/">Dev</a>
      </div>
    </header>

    <div class="card">
      <form method="post">
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="section" style="border-color: rgba(240,91,86,0.5); color:#ff7d7d;">
            {{ form.non_field_errors }}
          </div>
        {% endif %}
        <div class="grid">
          <div>
            <label>Артикул *</label>
            {{ form.sku_code.errors }}{% if form.sku_code.errors %}{% render_field form.sku_code class+="field-error" %}{% else %}{% render_field form.sku_code %}{% endif %}
          </div>
          <div>
            <label>Название *</label>
            {{ form.name.errors }}{% if form.name.errors %}{% render_field form.name class+="field-error" %}{% else %}{% render_field form.name %}{% endif %}
          </div>
          <div>
            <label>Клиент</label>
            {{ form.agency.errors }}{% if form.agency.errors %}{% render_field form.agency class+="field-error" %}{% else %}{% render_field form.agency %}{% endif %}
          </div>
          <div>
            <label>Маркетплейс</label>
            {{ form.market.errors }}{% if form.market.errors %}{% render_field form.market class+="field-error" %}{% else %}{% render_field form.market %}{% endif %}
          </div>
          <div>
            <label>Источник</label>
            {{ form.source.errors }}{% if form.source.errors %}{% render_field form.source class+="field-error" %}{% else %}{% render_field form.source %}{% endif %}
          </div>
          <div>
            <label>Внешний ID</label>
            {{ form.source_reference.errors }}{% if form.source_reference.errors %}{% render_field form.source_reference class+="field-error" %}{% else %}{% render_field form.source_reference %}{% endif %}
          </div>
        </div>

        <div class="section">
          <h3>Характеристики</h3>
          <div class="grid">
            <div><label>Цвет (текст)</label>{{ form.color.errors }}{% if form.color.errors %}{% render_field form.color class+="field-error" %}{% else %}{% render_field form.color %}{% endif %}</div>
            <div><label>Цвет (справочник)</label>{{ form.color_ref.errors }}{% if form.color_ref.errors %}{% render_field form.color_ref class+="field-error" %}{% else %}{% render_field form.color_ref %}{% endif %}</div>
            <div><label>Размер товара</label>{{ form.size.errors }}{% if form.size.errors %}{% render_field form.size class+="field-error" %}{% else %}{% render_field form.size %}{% endif %}</div>
            <div><label>Вес, кг</label>{{ form.weight_kg.errors }}{% if form.weight_kg.errors %}{% render_field form.weight_kg class+="field-error" %}{% else %}{% render_field form.weight_kg %}{% endif %}</div>
            <div><label>Объем</label>{{ form.volume.errors }}{% if form.volume.errors %}{% render_field form.volume class+="field-error" %}{% else %}{% render_field form.volume %}{% endif %}</div>
            <div><label>Длина, мм</label>{{ form.length_mm.errors }}{% if form.length_mm.errors %}{% render_field form.length_mm class+="field-error" %}{% else %}{% render_field form.length_mm %}{% endif %}</div>
            <div><label>Ширина, мм</label>{{ form.width_mm.errors }}{% if form.width_mm.errors %}{% render_field form.width_mm class+="field-error" %}{% else %}{% render_field form.width_mm %}{% endif %}</div>
            <div><label>Высота, мм</label>{{ form.height_mm.errors }}{% if form.height_mm.errors %}{% render_field form.height_mm class+="field-error" %}{% else %}{% render_field form.height_mm %}{% endif %}</div>
          </div>
        </div>

        <div class="section">
          <h3>Дополнительно</h3>
          <div class="grid">
            <div><label>Название для печати</label>{{ form.name_print.errors }}{% if form.name_print.errors %}{% render_field form.name_print class+="field-error" %}{% else %}{% render_field form.name_print %}{% endif %}</div>
            <div>
              <label>ШК товара <span class="muted" style="font-weight:400;">(EAN-13)</span></label>
              <div style="display:flex; gap:8px; align-items:center;">
                {{ form.code.errors }}{% if form.code.errors %}{% render_field form.code class+="field-error" id="field-code" %}{% else %}{% render_field form.code id="field-code" %}{% endif %}
                <button type="button" id="gen-code" class="btn" style="padding:8px 10px; min-width:40px;" title="Добавить ШК товара (EAN-13)">+ШК</button>
              </div>
            </div>
            <div><label>Пол</label>{{ form.gender.errors }}{% if form.gender.errors %}{% render_field form.gender class+="field-error" %}{% else %}{% render_field form.gender %}{% endif %}</div>
            <div><label>Сезон</label>{{ form.season.errors }}{% if form.season.errors %}{% render_field form.season class+="field-error" %}{% else %}{% render_field form.season %}{% endif %}</div>
            <div><label>Доп. имя</label>{{ form.additional_name.errors }}{% if form.additional_name.errors %}{% render_field form.additional_name class+="field-error" %}{% else %}{% render_field form.additional_name %}{% endif %}</div>
            <div><label>Категория</label>{{ form.tovar_category.errors }}{% if form.tovar_category.errors %}{% render_field form.tovar_category class+="field-error" %}{% else %}{% render_field form.tovar_category %}{% endif %}</div>
            <div><label>Вид товара</label>{{ form.vid_tovar.errors }}{% if form.vid_tovar.errors %}{% render_field form.vid_tovar class+="field-error" %}{% else %}{% render_field form.vid_tovar %}{% endif %}</div>
            <div><label>Тип товара</label>{{ form.type_tovar.errors }}{% if form.type_tovar.errors %}{% render_field form.type_tovar class+="field-error" %}{% else %}{% render_field form.type_tovar %}{% endif %}</div>
            <div><label>Бренд</label>{{ form.brand.errors }}{% if form.brand.errors %}{% render_field form.brand class+="field-error" %}{% else %}{% render_field form.brand %}{% endif %}</div>
            <div><label>Страна производства</label>{{ form.made_in.errors }}{% if form.made_in.errors %}{% render_field form.made_in class+="field-error" %}{% else %}{% render_field form.made_in %}{% endif %}</div>
          </div>
          <div class="grid">
            <div><label>Состав</label>{{ form.composition.errors }}{% if form.composition.errors %}{% render_field form.composition class+="field-error" %}{% else %}{% render_field form.composition %}{% endif %}</div>
            <div><label>Дата произв.</label>{{ form.cr_product_date.errors }}{% if form.cr_product_date.errors %}{% render_field form.cr_product_date class+="field-error" %}{% else %}{% render_field form.cr_product_date %}{% endif %}</div>
            <div><label>Срок годн.</label>{{ form.end_product_date.errors }}{% if form.end_product_date.errors %}{% render_field form.end_product_date class+="field-error" %}{% else %}{% render_field form.end_product_date %}{% endif %}</div>
          </div>
          <div class="row">
            <label class="pill">{{ form.honest_sign }} Честный знак</label>
            <label class="pill">{{ form.use_nds }} НДС</label>
            <label class="pill">{{ form.sign_akciz }} Акциз</label>
          </div>
        </div>

        <div class="section">
          <h3>Медиа и описания</h3>
          <div class="grid">
            <div><label>Ссылка на фото</label>{{ form.img.errors }}{% if form.img.errors %}{% render_field form.img class+="field-error" %}{% else %}{% render_field form.img %}{% endif %}</div>
            <div><label>Комментарий к фото</label>{{ form.img_comment.errors }}{% if form.img_comment.errors %}{% render_field form.img_comment class+="field-error" %}{% else %}{% render_field form.img_comment %}{% endif %}</div>
          </div>
          <div>
            <label>Описание</label>
            {{ form.description.errors }}{% if form.description.errors %}{% render_field form.description class+="field-error" %}{% else %}{% render_field form.description %}{% endif %}
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="submit" class="btn primary">{{ submit_label }}</button>
          <a class="btn" href="{{ request.GET.next|default:'/sku/' }}">Отмена</a>
        </div>
      </form>
    </div>
  </div>
  <div class="modal" id="label-preview">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <div class="muted">FULLBOX · {% include "partials/current_user.html" %}</div>
          <strong>Превью этикетки</strong>
          <div class="muted" style="margin-top:4px;">Размер этикетки: 58x40 мм</div>
        </div>
        <button class="btn" id="label-preview-close" type="button">Закрыть</button>
      </div>
      <div class="printer-row">
        <label for="label-printer">Принтер этикеток</label>
        <input id="label-printer" list="label-printers" placeholder="Выберите или введите">
        <datalist id="label-printers">
          <option value="Zebra GK420d">
          <option value="Zebra ZD421">
          <option value="TSC TE200">
          <option value="TSC TE310">
          <option value="Honeywell PC42t">
        </datalist>
      </div>
      <div class="label-mode">
        <button class="btn primary" type="button" data-label-mode="cz">Этикетка товара с ЧЗ</button>
        <button class="btn" type="button" data-label-mode="no-cz">Этикетка товара без ЧЗ</button>
      </div>
      <div class="label-stage" style="--label-width: 58mm; --label-height: 40mm;">
        <div class="label-size-badge">58x40 мм</div>
        <div class="label-preview">
          {% include "labels/_label_item.html" %}
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn primary" type="button" id="label-print">Печать</button>
      </div>
    </div>
  </div>
{{ label_settings|json_script:"label-settings-data" }}
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</body>
<script>
  (function(){
    const genBtn = document.getElementById('gen-code');
    const codeInput = document.getElementById('field-code');
    if (genBtn && codeInput) {
      genBtn.addEventListener('click', () => {
        const base = `2${Array.from({ length: 11 }, () => Math.floor(Math.random() * 10)).join('')}`;
        const digits = base.split('').map(Number);
        const sum = digits
          .reverse()
          .reduce((acc, digit, idx) => acc + digit * (idx % 2 === 0 ? 3 : 1), 0);
        const check = (10 - (sum % 10)) % 10;
        codeInput.value = `${base}${check}`;
      });
    }

    const preview = document.getElementById('label-preview');
    const openBtn = document.getElementById('label-preview-open');
    const closeBtn = document.getElementById('label-preview-close');
    const printBtn = document.getElementById('label-print');
    const printerInput = document.getElementById('label-printer');
    const labelModeButtons = document.querySelectorAll('[data-label-mode]');
    const labelPreview = preview ? preview.querySelector('.label-preview') : null;
    const labelSettingsEl = document.getElementById('label-settings-data');
    let labelSettingsData = {};
    let labelFontSizes = null;
    let labelEnabled = null;
    const getLabelSettingsForMode = (mode) => {
      const key = mode === 'cz' ? 'item_cz' : 'item';
      return (labelSettingsData && labelSettingsData[key]) || {};
    };
    const applyLabelSettingsForMode = (mode) => {
      const settings = getLabelSettingsForMode(mode);
      labelFontSizes = settings && settings.fonts ? settings.fonts : null;
      labelEnabled = settings && settings.enabled ? settings.enabled : null;
    };
    if (labelSettingsEl) {
      try {
        labelSettingsData = JSON.parse(labelSettingsEl.textContent || '{}') || {};
      } catch (err) {
        labelSettingsData = {};
      }
    }
    const params = new URLSearchParams(window.location.search);
    const printMode = params.get('print') === '1';
    const nextParam = params.get('next') || '';
    const sameOriginReferrer = document.referrer && document.referrer.startsWith(window.location.origin);
    const referrerPath = sameOriginReferrer ? document.referrer.replace(window.location.origin, '') : '';
    const backUrl = nextParam && nextParam.startsWith('/') ? nextParam : (referrerPath || '/sku/');

    const getValue = (id) => {
      const el = document.getElementById(id);
      if (!el) {
        return '';
      }
      if (el.tagName === 'SELECT') {
        const option = el.options[el.selectedIndex];
        if (!option || !option.value) {
          return '';
        }
        return (option.text || '').trim();
      }
      return (el.value || '').trim();
    };

    const pickValue = (ids) => {
      for (const id of ids) {
        const value = getValue(id);
        if (value) {
          return value;
        }
      }
      return '';
    };

    const setField = (name, value) => {
      const el = preview.querySelector(`[data-field="${name}"]`);
      if (el) {
        el.textContent = value || '—';
      }
    };

    const setInfoLine = (key, value, label) => {
      const el = preview.querySelector(`[data-info="${key}"]`);
      if (!el) {
        return;
      }
      if (value) {
        el.textContent = label ? `${label}${value}` : value;
        el.style.display = '';
      } else {
        el.textContent = '';
        el.style.display = 'none';
      }
    };

    const setNoCzLine = (key, value, label) => {
      const el = preview.querySelector(`[data-no-cz="${key}"]`);
      if (!el) {
        return;
      }
      if (value) {
        el.textContent = label ? `${label}${value}` : value;
        el.style.display = '';
      } else {
        el.textContent = '';
        el.style.display = 'none';
      }
    };

    const setRowVisible = (selector, hasValue) => {
      const row = preview.querySelector(selector);
      if (!row) {
        return;
      }
      row.style.display = hasValue ? '' : 'none';
    };

    const isEnabled = (field) => !labelEnabled || labelEnabled[field] !== false;

    const limitText = (text, maxLength = 30) => {
      if (!text) {
        return '';
      }
      const trimmed = String(text).trim();
      if (!trimmed) {
        return '';
      }
      if (trimmed.length <= maxLength) {
        return trimmed;
      }
      return trimmed.slice(0, maxLength);
    };

    const renderBarcode = (value) => {
      const czSvgs = preview.querySelectorAll('[data-barcode-svg]');
      const noCzSvgs = preview.querySelectorAll('[data-barcode-no-cz]');
      const digits = (value || '').replace(/\D/g, '');
      if (!czSvgs.length && !noCzSvgs.length) {
        return;
      }
      if (!digits) {
        czSvgs.forEach((svg) => {
          svg.innerHTML = '';
        });
        noCzSvgs.forEach((svg) => {
          svg.innerHTML = '';
        });
        return;
      }
      if (window.JsBarcode) {
        const useEan = digits.length >= 12;
        czSvgs.forEach((svg) => {
          JsBarcode(svg, useEan ? digits : value, {
            format: useEan ? 'ean13' : 'CODE128',
            displayValue: false,
            margin: 0,
            lineColor: '#111',
            height: 24,
            width: 1,
            fontSize: 5,
            textMargin: 0,
          });
        });
        noCzSvgs.forEach((svg) => {
          JsBarcode(svg, useEan ? digits : value, {
            format: useEan ? 'ean13' : 'CODE128',
            displayValue: false,
            margin: 0,
            lineColor: '#111',
            height: 24,
            width: 1,
            fontSize: 5,
            textMargin: 0,
          });
          svg.setAttribute('preserveAspectRatio', 'none');
          svg.setAttribute('width', '100%');
          svg.setAttribute('height', '100%');
        });
      }
    };

    const renderQr = (value) => {
      const box = preview.querySelector('[data-qr-box]');
      if (!box) {
        return;
      }
      box.innerHTML = '';
      if (!value) {
        return;
      }
      if (window.QRCode) {
        new QRCode(box, {
          text: value,
          width: 64,
          height: 64,
          correctLevel: QRCode.CorrectLevel.M,
        });
      }
    };

    const applyFontVar = (root, name, size) => {
      if (!root) {
        return;
      }
      if (Number.isFinite(size)) {
        root.style.setProperty(name, `${size}mm`);
      } else {
        root.style.removeProperty(name);
      }
    };

    const applyFontSizes = (root, sizes) => {
      if (!sizes) {
        return;
      }
      applyFontVar(root, '--font-barcode', sizes.barcode);
      applyFontVar(root, '--font-article', sizes.article);
      applyFontVar(root, '--font-name', sizes.name);
      applyFontVar(root, '--font-size', sizes.size);
      applyFontVar(root, '--font-brand', sizes.brand);
      applyFontVar(root, '--font-subject', sizes.subject);
      applyFontVar(root, '--font-color', sizes.color);
      applyFontVar(root, '--font-composition', sizes.composition);
      applyFontVar(root, '--font-supplier', sizes.supplier);
      applyFontVar(root, '--font-country', sizes.country);
    };

    const updatePreview = () => {
      const skuCodeRaw = getValue('id_sku_code');
      const skuCode = isEnabled('article') ? limitText(skuCodeRaw) : '';
      setField('sku_code', skuCode);
      setField('size', isEnabled('size') ? limitText(getValue('id_size')) : '');
      const nameRaw = pickValue(['id_name_print', 'id_name']);
      const nameValue = isEnabled('name') ? limitText(nameRaw) : '';
      const nameNoCz = isEnabled('name') ? limitText(nameRaw) : '';
      const sizeValue = isEnabled('size') ? limitText(getValue('id_size')) : '';
      const madeInValue = isEnabled('country') ? limitText(getValue('id_made_in')) : '';
      const rawBrandValue = getValue('id_brand');
      const brandValue = rawBrandValue.toLowerCase() === 'nobrand' ? '' : rawBrandValue;
      const brandPrint = isEnabled('brand') ? limitText(brandValue) : '';
      const subjectValue = isEnabled('subject')
        ? limitText(pickValue(['id_tovar_category', 'id_vid_tovar', 'id_type_tovar']))
        : '';
      const colorText = isEnabled('color')
        ? limitText(getValue('id_color') || pickValue(['id_color_ref']))
        : '';
      const compositionValue = isEnabled('composition') ? limitText(getValue('id_composition')) : '';
      const supplierValue = isEnabled('supplier') ? limitText(getValue('id_agency')) : '';
      setInfoLine('name', nameValue);
      setInfoLine('size', sizeValue, 'р-р: ');
      setInfoLine('brand', brandPrint);
      setInfoLine('subject', subjectValue);
      setInfoLine('color', colorText);
      setInfoLine('composition', compositionValue, 'Состав: ');
      setInfoLine('supplier', supplierValue, 'Поставщик: ');
      setInfoLine('article', skuCode, 'Артикул: ');
      setNoCzLine('article', skuCode ? `Артикул: ${skuCode}` : '');
      setNoCzLine('name', nameNoCz);
      setNoCzLine('brand', brandPrint, 'Бренд: ');
      setNoCzLine('color', colorText, 'Цвет: ');
      setNoCzLine('composition', compositionValue, 'Состав: ');
      setNoCzLine('supplier', supplierValue, 'Поставщик: ');
      setNoCzLine('country', madeInValue, 'Страна: ');
      setNoCzLine('size', sizeValue, 'Р-р: ');
      const hasBrandColor = Boolean(brandPrint || colorText);
      setRowVisible('[data-info-row="brand-color"]', hasBrandColor);
      setRowVisible('[data-no-cz-row="brand-color"]', hasBrandColor);
      const barcodeValue = isEnabled('barcode') ? pickValue(['field-code', 'id_code']) : '';
      setField('barcode', barcodeValue);
      const barcodeDigits = (barcodeValue || '').replace(/\D/g, '');
      preview.querySelectorAll('[data-barcode-value]').forEach((el) => {
        if (barcodeDigits || barcodeValue) {
          el.textContent = barcodeDigits || barcodeValue;
          el.style.display = '';
        } else {
          el.textContent = '';
          el.style.display = 'none';
        }
      });
      const barcodeExtra = getValue('id_source_reference') || skuCodeRaw;
      setField('barcode_extra', barcodeExtra);
      renderBarcode(barcodeValue);
      const qrValue = barcodeValue ? [barcodeValue, barcodeExtra].filter(Boolean).join(' ') : '';
      renderQr(qrValue);
      if (labelPreview && labelFontSizes) {
        applyFontSizes(labelPreview, labelFontSizes);
      }
    };

    if (openBtn && preview) {
      openBtn.addEventListener('click', (event) => {
        event.preventDefault();
        updatePreview();
        preview.classList.add('active');
      });
    }
    const setLabelMode = (mode) => {
      const normalized = mode === 'no-cz' ? 'no-cz' : 'cz';
      applyLabelSettingsForMode(normalized);
      if (!labelPreview) {
        return normalized;
      }
      labelPreview.classList.toggle('no-cz', normalized === 'no-cz');
      labelModeButtons.forEach((btn) => {
        const active = btn.dataset.labelMode === normalized;
        btn.classList.toggle('primary', active);
      });
      localStorage.setItem('label_mode', normalized);
      updatePreview();
      return normalized;
    };
    if (labelModeButtons.length) {
      const storedMode = localStorage.getItem('label_mode');
      const queryMode = params.get('label_mode');
      const initialMode = queryMode || (printMode ? 'no-cz' : (storedMode || 'cz'));
      setLabelMode(initialMode);
      labelModeButtons.forEach((btn) => {
        btn.addEventListener('click', () => setLabelMode(btn.dataset.labelMode));
      });
    }
    if (closeBtn) {
      closeBtn.addEventListener('click', () => {
        preview.classList.remove('active');
        if (printMode) {
          window.location.href = backUrl;
        }
      });
    }
    if (printBtn) {
      printBtn.addEventListener('click', () => {
        updatePreview();
        window.print();
      });
    }
    window.addEventListener('afterprint', () => {
      if (printMode) {
        window.location.href = backUrl;
      }
    });

    if (printerInput) {
      const stored = localStorage.getItem('label_printer');
      if (stored) {
        printerInput.value = stored;
      }
      printerInput.addEventListener('change', () => {
        localStorage.setItem('label_printer', printerInput.value.trim());
      });
    }

    const fieldsToWatch = [
      'id_name',
      'id_name_print',
      'id_sku_code',
      'id_size',
      'id_brand',
      'id_tovar_category',
      'id_vid_tovar',
      'id_type_tovar',
      'id_color',
      'id_color_ref',
      'id_composition',
      'id_agency',
      'field-code',
      'id_code',
      'id_source_reference',
      'id_made_in',
    ];
    fieldsToWatch.forEach((id) => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', updatePreview);
        el.addEventListener('change', updatePreview);
      }
    });
    if (printMode && preview) {
      updatePreview();
      preview.classList.add('active');
    }
  })();
</script>
</html>


